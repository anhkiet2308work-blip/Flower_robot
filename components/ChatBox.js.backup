import { useState, useEffect, useRef } from 'react'
import axios from 'axios'

export default function ChatBox({ sensorData }) {
  const [messages, setMessages] = useState([])
  const [input, setInput] = useState('')
  const [loading, setLoading] = useState(false)
  const [isListening, setIsListening] = useState(false)
  const [recognition, setRecognition] = useState(null)
  const [isSpeechEnabled, setIsSpeechEnabled] = useState(true)
  const [isSpeaking, setIsSpeaking] = useState(false)

  // Load voices for Speech Synthesis
  useEffect(() => {
    if (typeof window !== 'undefined' && 'speechSynthesis' in window) {
      // Load voices
      const loadVoices = () => {
        const voices = window.speechSynthesis.getVoices()
        console.log('ğŸ¤ Loaded voices:', voices.length)
        voices.forEach(voice => {
          if (voice.lang.startsWith('vi')) {
            console.log('ğŸ‡»ğŸ‡³ Vietnamese voice available:', voice.name, voice.lang)
          }
        })
      }
      
      loadVoices()
      
      // Chrome loads voices asynchronously
      if (window.speechSynthesis.onvoiceschanged !== undefined) {
        window.speechSynthesis.onvoiceschanged = loadVoices
      }
    }
  }, [])

  // Initialize Web Speech API
  useEffect(() => {
    if (typeof window !== 'undefined' && ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition
      const recognitionInstance = new SpeechRecognition()
      
      recognitionInstance.continuous = false
      recognitionInstance.interimResults = false
      recognitionInstance.lang = 'vi-VN' // Vietnamese language
      
      recognitionInstance.onresult = (event) => {
        const transcript = event.results[0][0].transcript
        const newInput = transcript
        setInput(newInput)
        setIsListening(false)
        
        // Tá»± Ä‘á»™ng gá»­i tin nháº¯n sau khi thu Ã¢m xong
        setTimeout(() => {
          if (newInput.trim()) {
            handleSendMessage(newInput)
          }
        }, 500)
      }
      
      recognitionInstance.onerror = (event) => {
        console.error('Speech recognition error:', event.error)
        setIsListening(false)
      }
      
      recognitionInstance.onend = () => {
        setIsListening(false)
      }
      
      setRecognition(recognitionInstance)
    }
  }, [])

  const speakText = (text) => {
    if (!isSpeechEnabled) {
      console.log('ğŸ”‡ Speech disabled')
      return
    }
    
    if (typeof window !== 'undefined' && 'speechSynthesis' in window) {
      console.log('ğŸ”Š Starting speech synthesis...')
      
      // Stop any ongoing speech
      window.speechSynthesis.cancel()
      
      // Small delay to ensure synthesis is ready
      setTimeout(() => {
        const utterance = new SpeechSynthesisUtterance(text)
        
        // Load voices if not loaded yet
        const voices = window.speechSynthesis.getVoices()
        console.log('ğŸ¤ Available voices:', voices.length)
        console.log('ğŸ¤ All voices:', voices.map(v => `${v.name} (${v.lang})`).join(', '))
        
        // Try to find Vietnamese voice - prioritize Microsoft voices
        let viVoice = voices.find(voice => 
          voice.lang === 'vi-VN' && voice.name.includes('Microsoft')
        )
        
        // Fallback: any vi-VN voice
        if (!viVoice) {
          viVoice = voices.find(voice => voice.lang === 'vi-VN')
        }
        
        // Fallback: any voice starting with 'vi'
        if (!viVoice) {
          viVoice = voices.find(voice => voice.lang.startsWith('vi'))
        }
        
        if (viVoice) {
          utterance.voice = viVoice
          utterance.lang = viVoice.lang
          console.log('ğŸ‡»ï¿½ Using Vietnamese voice:', viVoice.name, viVoice.lang)
        } else {
          // Force Vietnamese even if no voice found
          utterance.lang = 'vi-VN'
          console.warn('âš ï¸ No Vietnamese voice found, forcing vi-VN lang')
          console.warn('ğŸ’¡ Please install Vietnamese language pack on Windows:')
          console.warn('   Settings > Time & Language > Language > Add Vietnamese')
        }
        
        utterance.rate = 0.9  // Slower for better pronunciation
        utterance.pitch = 1.0
        utterance.volume = 1.0
        
        utterance.onstart = () => {
          console.log('âœ… Speech started with voice:', utterance.voice?.name || 'default')
          setIsSpeaking(true)
        }
        utterance.onend = () => {
          console.log('âœ… Speech ended')
          setIsSpeaking(false)
        }
        utterance.onerror = (event) => {
          console.error('âŒ Speech error:', event.error)
          setIsSpeaking(false)
        }
        
        window.speechSynthesis.speak(utterance)
        console.log('ğŸ“¢ Speech queued')
      }, 100)
    } else {
      console.error('âŒ Speech Synthesis not supported')
    }
  }

  const toggleSpeech = () => {
    if (isSpeaking) {
      window.speechSynthesis.cancel()
      setIsSpeaking(false)
    }
    setIsSpeechEnabled(!isSpeechEnabled)
  }

  const toggleListening = () => {
    if (!recognition) {
      alert('TrÃ¬nh duyá»‡t cá»§a báº¡n khÃ´ng há»— trá»£ nháº­n dáº¡ng giá»ng nÃ³i')
      return
    }

    if (isListening) {
      recognition.stop()
      setIsListening(false)
    } else {
      recognition.start()
      setIsListening(true)
    }
  }

  const handleSendMessage = async (message) => {
    const textToSend = message || input
    if (!textToSend.trim()) return

    const userMessage = { role: 'user', content: textToSend }
    setMessages(prev => [...prev, userMessage])
    setInput('')
    setLoading(true)

    try {
      const response = await axios.post('/api/chat', {
        message: textToSend,
        sensorData,
      })

      const botMessage = { role: 'assistant', content: response.data.reply }
      setMessages(prev => [...prev, botMessage])
      
      // Äá»c cÃ¢u tráº£ lá»i báº±ng giá»ng nÃ³i
      speakText(response.data.reply)
    } catch (error) {
      console.error('Chat error:', error)
      const errorMessage = { 
        role: 'assistant', 
        content: 'Xin lá»—i, Ä‘Ã£ cÃ³ lá»—i xáº£y ra. Vui lÃ²ng thá»­ láº¡i.' 
      }
      setMessages(prev => [...prev, errorMessage])
    } finally {
      setLoading(false)
    }
  }

  const handleSend = () => {
    handleSendMessage(input)
  }

  const handleKeyPress = (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault()
      handleSend()
    }
  }

  return (
    <div className="backdrop-blur-xl bg-white/70 rounded-xl sm:rounded-2xl shadow-xl p-3 sm:p-6 md:p-8 flex flex-col h-[500px] sm:h-[600px] border border-white/20">
      <div className="flex items-center justify-between mb-3 sm:mb-6">
        <h3 className="text-lg sm:text-xl md:text-2xl font-bold bg-gradient-to-r from-purple-600 to-blue-600 bg-clip-text text-transparent flex items-center">
          <svg className="w-6 h-6 sm:w-8 sm:h-8 mr-2 sm:mr-3 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
          </svg>
          <span className="truncate">Chat vá»›i Robot AI</span>
        </h3>
        
        <button
          onClick={toggleSpeech}
          className={`flex items-center gap-1 sm:gap-2 px-2 sm:px-3 py-1 sm:py-2 rounded-lg transition-all text-xs sm:text-sm font-semibold ${
            isSpeechEnabled 
              ? 'bg-green-100 text-green-700 hover:bg-green-200' 
              : 'bg-gray-100 text-gray-500 hover:bg-gray-200'
          }`}
          title={isSpeechEnabled ? 'Táº¯t Ã¢m thanh' : 'Báº­t Ã¢m thanh'}
        >
          {isSpeechEnabled ? (
            <>
              <span className="text-base sm:text-lg">ğŸ”Š</span>
              <span className="hidden sm:inline">{isSpeaking ? 'Äang Ä‘á»c...' : 'Ã‚m thanh báº­t'}</span>
            </>
          ) : (
            <>
              <span className="text-base sm:text-lg">ğŸ”‡</span>
              <span className="hidden sm:inline">Ã‚m thanh táº¯t</span>
            </>
          )}
        </button>
      </div>
      
      <div className="flex-1 overflow-y-auto mb-3 sm:mb-6 space-y-2 sm:space-y-4">
        {messages.length === 0 && (
          <div className="text-center text-gray-600 mt-8 sm:mt-16">
            <div className="text-4xl sm:text-6xl mb-3 sm:mb-4">ğŸ¤–</div>
            <p className="text-base sm:text-xl font-bold px-2">Xin chÃ o! TÃ´i lÃ  trá»£ lÃ½ AI cá»§a robot.</p>
            <p className="text-sm sm:text-base mt-2 sm:mt-3 px-4">HÃ£y há»i tÃ´i vá» dá»¯ liá»‡u cáº£m biáº¿n, thá»i tiáº¿t, hoáº·c Ä‘iá»u khiá»ƒn robot!</p>
          </div>
        )}
        {messages.map((msg, idx) => (
          <div
            key={idx}
            className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}
          >
            <div
              className={`max-w-[85%] sm:max-w-[70%] md:max-w-[60%] rounded-lg sm:rounded-xl px-3 sm:px-5 py-2 sm:py-3 shadow-md ${
                msg.role === 'user'
                  ? 'bg-gradient-to-r from-blue-500 to-purple-500 text-white'
                  : 'bg-white/90 text-gray-800 border border-white/40'
              }`}
            >
              <p className="whitespace-pre-wrap text-sm sm:text-base">{msg.content}</p>
            </div>
          </div>
        ))}
        {loading && (
          <div className="flex justify-start">
            <div className="bg-gray-100 rounded-lg px-4 py-2">
              <div className="flex space-x-2">
                <div className="w-2 h-2 bg-gray-500 rounded-full animate-bounce"></div>
                <div className="w-2 h-2 bg-gray-500 rounded-full animate-bounce" style={{ animationDelay: '0.1s' }}></div>
                <div className="w-2 h-2 bg-gray-500 rounded-full animate-bounce" style={{ animationDelay: '0.2s' }}></div>
              </div>
            </div>
          </div>
        )}
      </div>

      <div className="flex gap-1 sm:gap-2">
        <input
          type="text"
          value={input}
          onChange={(e) => setInput(e.target.value)}
          onKeyPress={handleKeyPress}
          placeholder="Nháº­p hoáº·c nháº¥n mic..."
          className="flex-1 backdrop-blur-sm bg-white/50 border border-white/30 rounded-lg sm:rounded-xl px-3 sm:px-4 py-2 sm:py-3 text-sm sm:text-base focus:outline-none focus:ring-2 focus:ring-purple-400 transition-all"
          disabled={loading}
        />
        <button
          onClick={toggleListening}
          disabled={loading}
          className={`px-2 sm:px-4 py-2 sm:py-3 rounded-lg sm:rounded-xl transition-all duration-300 font-semibold text-sm sm:text-base ${
            isListening 
              ? 'bg-red-500 text-white animate-pulse' 
              : 'bg-white/70 text-gray-700 hover:bg-white'
          }`}
          title={isListening ? 'Äang nghe...' : 'Nháº¥n Ä‘á»ƒ nÃ³i'}
        >
          {isListening ? (
            <span className="hidden sm:inline">ğŸ¤ Äang nghe...</span>
          ) : (
            'ğŸ¤'
          )}
          {isListening && <span className="sm:hidden">ğŸ¤</span>}
        </button>
        <button
          onClick={handleSend}
          disabled={loading || !input.trim()}
          className="bg-gradient-to-r from-purple-500 to-blue-500 text-white px-3 sm:px-6 py-2 sm:py-3 rounded-lg sm:rounded-xl hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-300 font-semibold text-sm sm:text-base whitespace-nowrap"
        >
          Gá»­i
        </button>
      </div>
    </div>
  )
}
